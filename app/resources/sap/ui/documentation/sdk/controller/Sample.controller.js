/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2017 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/documentation/sdk/controller/BaseController","sap/ui/model/json/JSONModel","sap/ui/core/Component","sap/ui/core/ComponentContainer","sap/ui/documentation/sdk/controller/util/ControlsInfo","sap/ui/documentation/sdk/util/ToggleFullScreenHandler","sap/m/Text","sap/ui/core/HTML","sap/ui/Device","sap/ui/core/routing/History","sap/m/library"],function(q,B,J,C,a,b,T,c,H,D,d,m){"use strict";var U=m.URLHelper;return B.extend("sap.ui.documentation.sdk.controller.Sample",{onInit:function(){this.getRouter().getRoute("sample").attachPatternMatched(this._onSampleMatched,this);this._viewModel=new J({showNavButton:true,showNewTab:false});Promise.all([sap.ui.getCore().loadLibrary("sap.ui.fl",{async:true}),sap.ui.getCore().loadLibrary("sap.ui.rta",{async:true})]).then(this._loadRTA.bind(this));this.getView().setModel(this._viewModel);},_onSampleMatched:function(e){var p=this.getView().byId("page");p.setBusy(true);this._sId=e.getParameter("arguments").id;b.loadData().then(function(o){this._loadSample(o);}.bind(this));},_loadSample:function(o){var p=this.getView().byId("page"),h=d.getInstance(),P=h.getPreviousHash(),M=this._viewModel.getData(),s=o.samples[this._sId],e;if(!s){q.sap.delayedCall(0,this,function(){p.setBusy(false);});this.getRouter().myNavToWithoutHash("sap.ui.documentation.sdk.view.NotFound","XML",false);return;}M.showNavButton=D.system.phone||!!P;M.previousSampleId=s.previousSampleId;M.nextSampleId=s.nextSampleId;p.setTitle("Sample: "+s.name);try{e=this._createComponent();}catch(f){p.removeAllContent();p.addContent(new c({text:"Error while loading the sample: "+f}));q.sap.delayedCall(0,this,function(){p.setBusy(false);});return;}this.getOwnerComponent()._oCurrentOpenedSample=e?e:undefined;var g=(this._oComp.getMetadata())?this._oComp.getMetadata().getConfig():null;var S=g&&g.sample||{};M.showNewTab=!!S.iframe;if(S.iframe){e=this._createIframe(e,S.iframe);}else{this.sIFrameUrl=null;}var i=!!S.stretch;var j=i?"100%":null;p.setEnableScrolling(!i);if(e.setHeight){e.setHeight(j);}p.removeAllContent();p.addContent(e);p.scrollTo(0);this._viewModel.setData(M);q.sap.delayedCall(0,this,function(){p.setBusy(false);});},onNewTab:function(){U.redirect(this.sIFrameUrl,true);},onPreviousSample:function(e){this.getRouter().navTo("sample",{id:this._viewModel.getProperty("/previousSampleId")},true);},onNextSample:function(e){this.getRouter().navTo("sample",{id:this._viewModel.getProperty("/nextSampleId")},true);},_createIframe:function(i,I){var s=this._sId,r=/\/([^\/]*)$/,e=/\..+$/,f,F,g;if(typeof I==="string"){f=r.exec(I);F=(f&&f.length>1?f[1]:I);g=e.exec(F)[0];var h=I.replace(e,"");this.sIFrameUrl=q.sap.getModulePath(s+"."+h,g||".html");}else{q.sap.log.error("no iframe source was provided");return;}if(!this._oHtmlControl){this._oHtmlControl=new H({id:"sampleFrame",content:'<iframe src="'+this.sIFrameUrl+'" id="sampleFrame" frameBorder="0"></iframe>'}).addEventDelegate({onAfterRendering:function(){if(!this._oHtmlControl._jQueryHTMLControlLoadEventAttached){this._oHtmlControl.$().on("load",function(){var S=this._oHtmlControl.$()[0].contentWindow,o=S.sap.ui.getCore();S.sap.ui.getCore().attachInit(function(){var j=q(document.body).hasClass("sapUiSizeCompact");o.applyTheme(this._oCore.getConfiguration().getTheme());o.getConfiguration().setRTL(this._oCore.getConfiguration().getRTL());S.jQuery('body').toggleClass("sapUiSizeCompact",j).toggleClass("sapUiSizeCozy",!j);o.notifyContentDensityChanged();}.bind(this));}.bind(this));this._oHtmlControl._jQueryHTMLControlLoadEventAttached=true;}}.bind(this)});}else{this._oHtmlControl.getDomRef().src=this.sIFrameUrl;}return this._oHtmlControl;},_createComponent:function(){var s='sampleComp-'+this._sId;var e=this._sId;var M=this.getOwnerComponent();this._oComp=sap.ui.component(s);if(this._oComp){this._oComp.destroy();}return M.runAsOwner(function(){this._oComp=sap.ui.getCore().createComponent({id:s,name:e});return new a({component:this._oComp});}.bind(this));},onNavBack:function(e){this.getRouter().myNavBack("home",{});},onNavToCode:function(e){this.getRouter().navTo("code",{id:this._sId},false);},onToggleFullScreen:function(e){T.updateMode(e,this.getView(),this);},_oRTA:null,_loadRTA:function(){sap.ui.require(["sap/ui/fl/Utils","sap/ui/fl/FakeLrepConnectorLocalStorage"],function(e,F){e.checkControlId=function(){return true;};F.enableFakeConnector({"isProductiveSystem":true});this.getView().byId("toggleRTA").setVisible(true);this.getRouter().attachRouteMatched(function(){if(this._oRTA){this._oRTA.destroy();this._oRTA=null;}},this);}.bind(this));},onToggleAdaptationMode:function(e){sap.ui.require(["sap/ui/rta/RuntimeAuthoring"],function(R){if(!this._oRTA){this._oRTA=new R({flexSettings:{developerMode:false}});this._oRTA.setRootControl(this.getView().byId("page").getContent()[0]);this._oRTA.attachStop(function(){this._oRTA.destroy();delete this._oRTA;}.bind(this));this._oRTA.start();}}.bind(this));}});});
